name: CI

on:
  push:
    branches: [ main, develop, claude/* ]
  pull_request:
    branches: [ main, develop ]

env:
  CARGO_TERM_COLOR: always

jobs:
  fmt:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust (fmt)
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Cargo fmt --check
        run: cargo fmt --all -- --check

  lint:
    name: Clippy
    needs: fmt
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust (clippy)
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Run clippy
        run: make lint

  test:
    name: Tests
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Run tests
        run: make test

      - name: Upload test logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cargo-test-logs
          path: target/debug/deps

  build-linux:
    name: Build (Linux release)
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Build release binaries
        run: cargo build --workspace --release

      - name: Package binaries
        run: |
          mkdir -p artifacts/linux
          cp target/release/vicaya artifacts/linux/vicaya
          cp target/release/vicaya-daemon artifacts/linux/vicaya-daemon
          cp target/release/vicaya-tui artifacts/linux/vicaya-tui

      - name: Upload Linux binaries
        uses: actions/upload-artifact@v4
        with:
          name: vicaya-linux-binaries
          path: artifacts/linux

  coverage:
    name: Coverage (llvm-cov)
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust + llvm-tools
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Generate coverage report
        run: cargo llvm-cov --workspace --lcov --output-path lcov.info

      - name: Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: lcov.info
          fail_ci_if_error: false

      - name: Export coverage summary
        run: cargo llvm-cov --workspace --summary-only > coverage-summary.txt

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-artifacts
          path: |
            lcov.info
            coverage-summary.txt

  macos-build:
    name: Build (macOS ${{ matrix.target }})
    needs: lint
    runs-on: macos-latest
    strategy:
      matrix:
        target: [aarch64-apple-darwin, x86_64-apple-darwin]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Add target
        run: rustup target add ${{ matrix.target }}

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Build release binaries
        run: cargo build --workspace --release --target ${{ matrix.target }}

      - name: Package binaries
        run: |
          mkdir -p artifacts/${{ matrix.target }}
          cp target/${{ matrix.target }}/release/vicaya artifacts/${{ matrix.target }}/vicaya
          cp target/${{ matrix.target }}/release/vicaya-daemon artifacts/${{ matrix.target }}/vicaya-daemon
          cp target/${{ matrix.target }}/release/vicaya-tui artifacts/${{ matrix.target }}/vicaya-tui

      - name: Upload macOS binaries
        uses: actions/upload-artifact@v4
        with:
          name: vicaya-${{ matrix.target }}-binaries
          path: artifacts/${{ matrix.target }}

  macos-universal:
    name: Build (macOS universal2)
    needs: macos-build
    runs-on: macos-latest
    steps:
      - name: Download arm64 artifacts
        uses: actions/download-artifact@v4
        with:
          name: vicaya-aarch64-apple-darwin-binaries
          path: dist/aarch64

      - name: Download x86_64 artifacts
        uses: actions/download-artifact@v4
        with:
          name: vicaya-x86_64-apple-darwin-binaries
          path: dist/x86_64

      - name: Create universal binaries
        run: |
          mkdir -p dist/universal/bin
          for bin in vicaya vicaya-daemon vicaya-tui; do
            lipo -create \
              dist/aarch64/$bin \
              dist/x86_64/$bin \
              -output dist/universal/bin/$bin
          done

      - name: Package universal bundle
        run: |
          cd dist/universal
          zip -r ../vicaya-universal-${{ github.sha }}.zip bin
          cd ..
          shasum -a 256 vicaya-universal-${{ github.sha }}.zip > vicaya-universal-${{ github.sha }}.sha256

      - name: Upload universal artifact
        uses: actions/upload-artifact@v4
        with:
          name: vicaya-universal
          path: |
            dist/vicaya-universal-${{ github.sha }}.zip
            dist/vicaya-universal-${{ github.sha }}.sha256
