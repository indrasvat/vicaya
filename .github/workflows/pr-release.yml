name: PR Preview Release

on:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  CARGO_TERM_COLOR: always

jobs:
  pr-release:
    runs-on: macos-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Add targets
        run: |
          rustup target add aarch64-apple-darwin
          rustup target add x86_64-apple-darwin

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Get version info
        id: version
        env:
          PR_SHA: ${{ github.event.pull_request.head.sha }}
          PR_NUM: ${{ github.event.pull_request.number }}
        run: |
          BASE_VERSION=$(grep -m1 'version = ' Cargo.toml | sed 's/.*"\(.*\)".*/\1/')
          SHORT_SHA=$(echo "$PR_SHA" | cut -c1-7)
          PREVIEW_VERSION="${BASE_VERSION}-pr.${PR_NUM}+${SHORT_SHA}"
          echo "base_version=${BASE_VERSION}" >> "$GITHUB_OUTPUT"
          echo "preview_version=${PREVIEW_VERSION}" >> "$GITHUB_OUTPUT"
          echo "short_sha=${SHORT_SHA}" >> "$GITHUB_OUTPUT"
          echo "tag_name=pr-${PR_NUM}-${SHORT_SHA}" >> "$GITHUB_OUTPUT"

      - name: Build for arm64
        run: cargo build --workspace --release --target aarch64-apple-darwin

      - name: Build for x86_64
        run: cargo build --workspace --release --target x86_64-apple-darwin

      - name: Create universal binaries
        run: |
          mkdir -p dist/universal/bin
          for bin in vicaya vicaya-daemon vicaya-tui; do
            lipo -create \
              target/aarch64-apple-darwin/release/$bin \
              target/x86_64-apple-darwin/release/$bin \
              -output dist/universal/bin/$bin
          done

      - name: Package tarball
        env:
          TAG_NAME: ${{ steps.version.outputs.tag_name }}
        run: |
          cd dist/universal
          tar -czvf "../vicaya-${TAG_NAME}-universal.tar.gz" bin
          cd ..
          shasum -a 256 "vicaya-${TAG_NAME}-universal.tar.gz" > "vicaya-${TAG_NAME}-universal.tar.gz.sha256"

      - name: Create PR preview release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag_name }}
          name: "PR #${{ github.event.pull_request.number }} Preview (${{ steps.version.outputs.short_sha }})"
          body: |
            ## Preview Release for PR #${{ github.event.pull_request.number }}

            **Commit:** ${{ github.event.pull_request.head.sha }}
            **Base Version:** ${{ steps.version.outputs.base_version }}
            **Preview Version:** `${{ steps.version.outputs.preview_version }}`

            > This is a preview release for testing purposes only.
            > It will be automatically deleted after 7 days.
          prerelease: true
          files: |
            dist/*.tar.gz
            dist/*.sha256

      - name: Comment on PR
        uses: actions/github-script@v7
        env:
          PREVIEW_VERSION: ${{ steps.version.outputs.preview_version }}
          TAG_NAME: ${{ steps.version.outputs.tag_name }}
          SHORT_SHA: ${{ steps.version.outputs.short_sha }}
        with:
          script: |
            const version = process.env.PREVIEW_VERSION;
            const tagName = process.env.TAG_NAME;
            const sha = process.env.SHORT_SHA;

            // Find and delete previous bot comments
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            for (const comment of comments.data) {
              if (comment.body.includes('Preview Release Available')) {
                await github.rest.issues.deleteComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: comment.id,
                });
              }
            }

            // Post new comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## Preview Release Available

            | | |
            |---|---|
            | **Version** | \`${version}\` |
            | **Commit** | \`${sha}\` |
            | **Release** | [${tagName}](https://github.com/${context.repo.owner}/${context.repo.repo}/releases/tag/${tagName}) |

            \`\`\`bash
            # Install via tarball
            curl -L https://github.com/${context.repo.owner}/${context.repo.repo}/releases/download/${tagName}/vicaya-${tagName}-universal.tar.gz | tar -xz
            \`\`\`
            `
            });
